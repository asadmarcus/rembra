<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assist</title>
    <style>
        * {
            margin: 0;
            padding        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
        };
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: transparent;
        }

        /* Chat Interface */
        .chat-interface {
            width: 100%;
            height: 100%;
            background: rgba(29, 28, 28, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px 20px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .chat-title {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #007AFF, #0056CC);
            color: white;
            padding: 12px 16px;
            border-radius: 20px 20px 4px 20px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .message.ai {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.4));
            backdrop-filter: blur(20px);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            border: 1.5px solid rgba(147, 51, 234, 0.3);
            box-shadow: 0 12px 24px rgba(147, 51, 234, 0.2);
            max-width: 320px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.ai .ai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            margin: 0;
            font-size: 12px;
            color: rgba(147, 51, 234, 0.9);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message.ai .ai-content {
            padding: 12px 16px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message.ai h1 { 
            font-size: 18px; 
            color: #9333ea; 
            margin: 12px 0 6px 0; 
            font-weight: 700;
            border-bottom: 1px solid rgba(147, 51, 234, 0.3);
            padding-bottom: 2px;
        }
        .message.ai h2 { 
            font-size: 16px; 
            color: #007aff; 
            margin: 10px 0 4px 0; 
            font-weight: 600;
        }
        .message.ai h3 { 
            font-size: 15px; 
            color: #ff9500; 
            margin: 8px 0 3px 0; 
            font-weight: 600;
        }
        .message.ai h4 { 
            font-size: 14px; 
            color: #34c759; 
            margin: 6px 0 2px 0; 
            font-weight: 600;
        }
        
        .message.ai p {
            margin: 4px 0;
            line-height: 1.5;
        }
        
        .message.ai strong {
            color: #ffffff;
            font-weight: 600;
        }
        
        .message.ai ul { 
            margin: 6px 0; 
            padding-left: 0; 
            background: rgba(147, 51, 234, 0.05);
            border-radius: 6px;
            padding: 6px;
        }
        .message.ai li { 
            display: flex; 
            align-items: flex-start; 
            gap: 6px; 
            margin: 3px 0;
            line-height: 1.4;
        }
        .message.ai li::before { 
            content: '‚ñ∏'; 
            color: #9333ea; 
            font-weight: bold; 
            font-size: 12px;
        }
        
        .message.ai code {
            background: rgba(255, 149, 0, 0.1);
            color: #ff9500;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .message.ai pre {
            background: rgba(255, 149, 0, 0.1);
            color: #ff9500;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .input-container {
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            line-height: 1.4;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            outline: none;
        }

        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #007bff00;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .send-btn:hover {
            background: #57585a;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .analyzing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 149, 0, 0.2);
            border-radius: 12px;
            margin: 0 20px 16px;
            font-size: 12px;
            color: rgba(255, 149, 0, 0.9);
            flex-shrink: 0;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 149, 0, 0.3);
            border-top: 2px solid rgba(255, 149, 0, 0.9);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Chat Interface - Always visible -->
    <div class="chat-interface" id="chatInterface">
        <div class="chat-header">
            <div class="chat-title">Rembra Assistant</div>
            <div class="header-buttons">
                <button class="header-btn" onclick="captureContext()" title="Capture Context">üëÅÔ∏è</button>
                <button class="header-btn" onclick="newChat()" title="New Chat">+</button>
                <button class="header-btn" onclick="closeChat()" title="Close">√ó</button>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <!-- Messages will be added here -->
        </div>

        <div class="analyzing-indicator" id="analyzingIndicator">
            <div class="spinner"></div>
            <span>Analyzing...</span>
        </div>

        <div class="input-container">
            <textarea 
                class="message-input" 
                id="messageInput" 
                placeholder="Type your message..."
                rows="1"
                onkeydown="handleKeyDown(event)"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                ‚Üë
            </button>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let isAnalyzing = false;
        let aiConnectionManager = null;
        let aiContextManager = null;

        // Initialize managers
        async function initializeManagers() {
            const { getInstance } = require('../services/AIConnectionManager');
            
            aiConnectionManager = getInstance();

            // Listen for AI responses
            aiConnectionManager.on('messageUpdate', (messages) => {
                updateMessages(messages);
            });

            aiConnectionManager.on('responseComplete', () => {
                hideAnalyzing();
                enableInput();
                
                // Check if this was an email reply and handle insertion
                handleEmailReplyCompletion();
            });
            
            console.log('‚úÖ AI managers initialized');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isAnalyzing) return;

            try {
                // Add user message immediately
                addMessage(message, true);
                input.value = '';
                
                // Show analyzing
                showAnalyzing();
                disableInput();

                // Determine if we need context capture
                const needsAnalysis = checkIfNeedsAnalysis(message);
                const isEmailReply = checkIfEmailReply(message);
                const isSimpleChat = checkIfSimpleChat(message);

                let contextData = null;

                if (isEmailReply) {
                    // Handle email reply flow
                    addMessage('Please select the email window to reply to...', false);
                    
                    const emailResult = await ipcRenderer.invoke('capture-email-context');
                    if (emailResult.success) {
                        contextData = emailResult.data;
                        // Store for later email insertion
                        window.pendingEmailContext = emailResult.data;
                    } else {
                        throw new Error(emailResult.error || 'Failed to capture email context');
                    }
                } else if (needsAnalysis) {
                    // Show window selection status
                    addMessage('Please select a window to analyze...', false);
                    
                    const analysisResult = await ipcRenderer.invoke('capture-window-content', { comprehensive: true });
                    if (analysisResult.success) {
                        contextData = analysisResult.data;
                        updateLastMessage('Analyzing comprehensive content (up to 25 pages)...');
                    } else {
                        throw new Error(analysisResult.error || 'Failed to capture window content');
                    }
                } else if (!isSimpleChat) {
                    // Regular context capture for complex questions
                    addMessage('Analyzing...', false);
                    
                    const contextResult = await ipcRenderer.invoke('capture-window-content');
                    if (contextResult.success) {
                        contextData = contextResult.data;
                    } else {
                        throw new Error(contextResult.error || 'Failed to capture context');
                    }
                }
                // For simple chat messages, skip context capture entirely

                // Send to AI
                await aiConnectionManager.sendMessage(message, contextData);

            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                addMessage('Error: ' + error.message, false);
                hideAnalyzing();
                enableInput();
            }
        }

        function checkIfNeedsAnalysis(message) {
            const lower = message.toLowerCase();
            
            // Analysis keywords - comprehensive list
            const analysisKeywords = [
                // Core analysis terms
                'analyze', 'analyse', 'analysis', 'summarize', 'summarise', 'summary',
                'read', 'review', 'examine', 'check', 'study', 'evaluate',
                
                // Content reference terms
                'what does', 'what is', 'explain this', 'describe this', 'tell me about this',
                'what\'s on', 'what\'s in', 'content', 'document', 'page', 'text',
                'screen', 'window', 'file', 'pdf', 'website', 'article',
                
                // Action terms for content
                'break down', 'go through', 'walk me through', 'look at',
                'understand', 'interpret', 'parse', 'process', 'extract',
                'find', 'search for', 'look for', 'identify',
                
                // Question patterns about content
                'what are the', 'what does the', 'how does this', 'why does this',
                'where is the', 'when does the', 'who is mentioned',
                'list the', 'show me the', 'give me the',
                
                // Comparative/research terms
                'compare', 'contrast', 'difference', 'similar', 'relate',
                'research', 'investigate', 'explore', 'dive into',
                
                // Output format requests
                'create a summary', 'make a list', 'bullet points', 'key points',
                'main ideas', 'important parts', 'highlights', 'takeaways'
            ];
            
            // Check for any analysis keywords
            return analysisKeywords.some(keyword => lower.includes(keyword));
        }

        function checkIfEmailReply(message) {
            const lower = message.toLowerCase();
            return lower.includes('reply') ||
                   lower.includes('respond') ||
                   lower.includes('answer this email') ||
                   lower.includes('draft a response') ||
                   lower.includes('email reply');
        }

        function checkIfSimpleChat(message) {
            const lower = message.toLowerCase();
            
            // Simple conversational patterns that don't need context
            const simpleChatPatterns = [
                // Greetings and basic interactions
                'hello', 'hi', 'hey', 'how are you', 'thanks', 'thank you',
                'good', 'great', 'ok', 'okay', 'yes', 'no', 'maybe', 'sure', 'cool', 'nice',
                'please', 'sorry', 'excuse me', 'pardon',
                
                // Questions about the AI itself
                'what can you do', 'what can you help', 'what are you', 'who are you',
                'what is your', 'tell me about yourself', 'what are your capabilities',
                'how can you help', 'what can you assist', 'what do you do',
                'can you help me with', 'what can you help me with',
                
                // General help and guidance  
                'help', 'how to use', 'how does this work', 'instructions',
                'guide', 'tutorial', 'show me how',
                
                // General questions (not about specific content)
                'what is ai', 'how to', 'can you', 'do you know',
                'tell me about ai', 'explain ai', 'what does ai do'
            ];
            
            // Check if message matches simple patterns
            for (const pattern of simpleChatPatterns) {
                if (lower.includes(pattern)) {
                    return true;
                }
            }
            
            // Very short messages are likely conversational
            if (message.length < 15) {
                return true;
            }
            
            return false;
        }

        function addMessage(text, isUser) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            if (isUser) {
                messageDiv.textContent = text;
            } else {
                const formattedContent = formatAIResponse(text);
                messageDiv.innerHTML = `
                    <div class="ai-header">
                        <span>Rembra Assistant</span>
                    </div>
                    <div class="ai-content">${formattedContent}</div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function updateMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            // Update the last AI message if it exists
            const lastMessage = messages[messages.length - 1];
            if (lastMessage && !lastMessage.isUser) {
                const aiMessages = container.querySelectorAll('.message.ai');
                if (aiMessages.length > 0) {
                    const lastAiMessage = aiMessages[aiMessages.length - 1];
                    const contentDiv = lastAiMessage.querySelector('.ai-content');
                    if (contentDiv) {
                        contentDiv.innerHTML = formatAIResponse(lastMessage.message);
                    }
                } else {
                    addMessage(lastMessage.message, false);
                }
            }
            
            container.scrollTop = container.scrollHeight;
        }

        function showAnalyzing() {
            isAnalyzing = true;
            document.getElementById('analyzingIndicator').style.display = 'flex';
        }

        function hideAnalyzing() {
            isAnalyzing = false;
            document.getElementById('analyzingIndicator').style.display = 'none';
        }

        function disableInput() {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

        function enableInput() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
        }

        async function captureContext() {
            try {
                showAnalyzing();
                
                const result = await ipcRenderer.invoke('capture-window-content');
                
                hideAnalyzing();
                
                if (result.success) {
                    addMessage('Context captured successfully!', false);
                    console.log('‚úÖ Context captured:', result.data);
                } else {
                    addMessage('Error capturing context: ' + result.error, false);
                }
            } catch (error) {
                hideAnalyzing();
                addMessage('Error capturing context: ' + error.message, false);
            }
        }

        function newChat() {
            // Clear messages
            document.getElementById('messagesContainer').innerHTML = '';
            
            // Clear conversation in AI manager
            if (aiConnectionManager) {
                aiConnectionManager.clearConversation();
            }
            
            // Clear pending email context
            window.pendingEmailContext = null;
            
            // Focus input
            document.getElementById('messageInput').focus();
            
            console.log('üÜï New chat started');
        }

        function closeChat() {
            // Close the window
            ipcRenderer.send('close-ai-assist');
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Listen for IPC events - removed sphere-specific events

        // Handle email reply completion
        async function handleEmailReplyCompletion() {
            if (!window.pendingEmailContext) return;
            
            const lastMessage = aiConnectionManager.lastMessages[aiConnectionManager.lastMessages.length - 1];
            if (!lastMessage || lastMessage.isUser) return;
            
            console.log('üìß Processing email reply completion...');
            
            try {
                const result = await ipcRenderer.invoke('insert-email-reply', {
                    aiResponse: lastMessage.message,
                    windowInfo: window.pendingEmailContext.windowInfo
                });
                
                // Add result message
                addMessage(result.message, false);
                
                // Clear pending context
                window.pendingEmailContext = null;
                
            } catch (error) {
                console.error('‚ùå Email reply insertion error:', error);
                addMessage('Error inserting email reply: ' + error.message, false);
            }
        }
        
        // Update last message helper
        function updateLastMessage(text) {
            const container = document.getElementById('messagesContainer');
            const aiMessages = container.querySelectorAll('.message.ai');
            
            if (aiMessages.length > 0) {
                const lastAiMessage = aiMessages[aiMessages.length - 1];
                const contentDiv = lastAiMessage.querySelector('div:last-child');
                if (contentDiv) {
                    contentDiv.textContent = text;
                }
            }
        }

        // Format AI response with enhanced styling
        function formatAIResponse(text) {
            let formatted = text;
            
            // Headers with better spacing
            formatted = formatted.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
            
            // Bold text
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Code blocks
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            // Inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Lists with better formatting
            formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/((?:<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>');
            
            // Paragraphs
            formatted = formatted.replace(/\n\n/g, '</p><p>');
            formatted = formatted.replace(/\n/g, '<br>');
            
            return `<p>${formatted}</p>`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeManagers();
            
            // Focus input immediately
            document.getElementById('messageInput').focus();
            
            console.log('ü§ñ AI Assist chat interface initialized');
        });
    </script>
</body>
</html>