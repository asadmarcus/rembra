<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
               <div class="content">
            <div class="transcript-container" id="transcriptContainer">
                <div class="empty-state">
                    🎤
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let isRecording = false;
        let isMinimized = false;
        let startTime = null;
        let durationInterval = null;idden;
            margin: 0;
            padding: 0;
        }

        .listen-panel {
            width: 280px;
            height: 320px;
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.7),
                0 8px 16px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .listen-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                rgba(0, 0, 0, 0.1) 100%);
            border-radius: 20px;
            pointer-events: none;
            z-index: 1;
        }

        .listen-panel > * {
            position: relative;
            z-index: 2;
        }

        /* Enhanced Header */
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 0 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .record-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .record-btn.recording {
            background: rgba(239, 68, 68, 0.9);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .listening-indicator {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        .listening-indicator.recording {
            color: #ef4444;
        }

        .header-buttons {
            display: flex;
            gap: 6px;
        }

        .header-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        /* Audio Visualization */
        .audio-viz {
            display: flex;
            align-items: center;
            gap: 1px;
            margin-left: auto;
            height: 20px;
            padding: 0 8px;
        }

        .viz-bar {
            width: 1.5px;
            background: rgba(34, 197, 94, 0.4);
            border-radius: 1px;
            transition: all 0.1s ease;
        }

        .viz-bar.active {
            background: rgba(34, 197, 94, 0.8);
        }

        /* Main Content */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        /* Live Transcription */
        .transcription-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .transcript-container {
            flex: 1;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 200px;
            max-height: 200px;
        }

        .transcript-container::-webkit-scrollbar {
            width: 2px;
        }

        .transcript-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .transcript-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1px;
        }

        /* Transcript Messages */
        .transcript-message {
            margin-bottom: 16px;
            animation: fadeInUp 0.3s ease;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .speaker-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
        }

        .speaker-avatar.speaker-2 {
            background: rgba(168, 85, 247, 0.8);
        }

        .speaker-avatar.speaker-3 {
            background: rgba(34, 197, 94, 0.8);
        }

        .speaker-name {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
        }

        .message-time {
            font-size: 10px;
            color: #64748b;
            margin-left: auto;
        }

        .message-content {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px 12px;
            margin-left: 28px;
            font-size: 13px;
            line-height: 1.5;
            color: #e2e8f0;
        }

        .message-content.partial {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            animation: pulse 2s infinite;
        }

        .message-content.processing {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #64748b;
            gap: 12px;
        }

        .empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .listen-panel {
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Minimized State */
        .listen-panel.minimized {
            height: 80px;
        }

        .listen-panel.minimized .content,
        .listen-panel.minimized .status-bar {
            display: none;
        }
    </style>
</head>
<body>
    <div class="listen-panel" id="listenPanel">
        <div class="header">
            <div class="header-content">
                <button class="record-btn idle" id="recordBtn">
                    <span id="recordIcon">▶</span>
                </button>
                <div class="listening-indicator" id="listeningIndicator">
                    Ready to record
                </div>
                <div class="audio-viz" id="audioViz">
                    <!-- Audio visualization bars -->
                </div>
            </div>
            <div class="header-buttons">
                <button class="header-btn" id="minimizeBtn">
                    <span id="minimizeIcon">⌄</span>
                </button>
                <button class="header-btn" id="closeBtn">×</button>
            </div>
        </div>

        <div class="content">
            <div class="transcript-container" id="transcriptContainer">
                <div class="empty-state">
                    �
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let isRecording = false;
        let isMinimized = false;
        let startTime = null;
        let durationInterval = null;
        let currentTranscript = [];
        let speakers = new Set();
        let transcriptionService = null;
        let audioVizInterval = null;
        let speakerColors = ['#3b82f6', '#a855f7', '#22c55e', '#f59e0b', '#ef4444'];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎤 Listen panel loaded, initializing...');
            
            // Initialize audio visualization
            initializeAudioViz();
            
            // Initialize transcription service
            initializeListen();
            
            // Set up UI event listeners
            setupEventListeners();
            
                        // Initialize UI state
            updateListeningIndicator('Ready to record', false);
            updateRecordButton();
        });

        function initializeAudioViz() {
            const audioViz = document.getElementById('audioViz');
            
            // Create 12 visualization bars for clean minimal look
            for (let i = 0; i < 12; i++) {
                const bar = document.createElement('div');
                bar.className = 'viz-bar';
                bar.style.height = '2px';
                audioViz.appendChild(bar);
            }
        }

        function setupEventListeners() {
            const minimizeBtn = document.getElementById('minimizeBtn');
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', toggleMinimize);
            }
            
            const closeBtn = document.getElementById('closeBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeListen);
            }
            
            const recordBtn = document.getElementById('recordBtn');
            if (recordBtn) {
                recordBtn.addEventListener('click', toggleRecording);
            }
        }

        function startAudioVisualization() {
            const bars = document.querySelectorAll('.viz-bar');
            
            audioVizInterval = setInterval(() => {
                bars.forEach((bar, index) => {
                    const height = Math.random() * 8 + 2; // Random height between 2-10px
                    const isActive = Math.random() > 0.6; // 40% chance to be active
                    
                    bar.style.height = height + 'px';
                    
                    if (isActive) {
                        bar.classList.add('active');
                    } else {
                        bar.classList.remove('active');
                    }
                });
            }, 150);
        }

        function stopAudioVisualization() {
            if (audioVizInterval) {
                clearInterval(audioVizInterval);
                audioVizInterval = null;
            }
            
            // Reset all bars to default state
            const bars = document.querySelectorAll('.viz-bar');
            bars.forEach(bar => {
                bar.style.height = '2px';
                bar.classList.remove('active');
            });
        }

        function setupTranscriptionEventListeners() {
            if (!transcriptionService) return;

            transcriptionService.on('started', (sessionId) => {
                updateListeningIndicator('Listening for audio', true);
                startAudioVisualization();
                clearTranscriptUI();
            });

            transcriptionService.on('partial', (data) => {
                updatePartialTranscript(data);
            });

            transcriptionService.on('final', (data) => {
                addFinalTranscript(data);
                speakers.add(data.speaker);
            });

            transcriptionService.on('turnEnd', (data) => {
                console.log('🔄 Turn ended:', data.speaker, data.text);
                addTurnEndIndicator(data);
            });

            transcriptionService.on('stopped', (session) => {
                updateListeningIndicator('Session saved', false);
                stopAudioVisualization();
                saveSession(session);
            });

            transcriptionService.on('error', (error) => {
                console.error('Transcription error:', error);
                updateListeningIndicator('Recording error', false);
                
                if (isRecording) {
                    isRecording = false;
                    updateRecordButton();
                    stopAudioVisualization();
                }
            });

            transcriptionService.on('disconnected', () => {
                updateListeningIndicator('Disconnected', false);
                stopAudioVisualization();
            });
        }

        async function initializeListen() {
            try {
                console.log('🔍 Initializing transcription service...');
                
                // Try Enhanced first, fallback to basic TranscriptionService
                try {
                    const EnhancedTranscriptionService = require('../services/EnhancedTranscriptionService');
                    transcriptionService = new EnhancedTranscriptionService();
                    console.log('🔍 EnhancedTranscriptionService loaded and instantiated');
                } catch (enhancedError) {
                    console.warn('⚠️ Enhanced service failed, using basic:', enhancedError.message);
                    transcriptionService = require('../services/TranscriptionService');
                    console.log('🔍 Basic TranscriptionService loaded (singleton)');
                }
                
                console.log('🔍 Transcription service instance created:', !!transcriptionService);
                
                // Verify the service has required methods
                if (!transcriptionService || typeof transcriptionService.setApiKey !== 'function') {
                    throw new Error('Transcription service missing required methods');
                }
                
                try {
                    const assemblyAIConfig = require('../config/assemblyai');
                    console.log('🔍 AssemblyAI config loaded:', !!assemblyAIConfig.apiKey);
                    
                    if (!assemblyAIConfig.apiKey) {
                        throw new Error('AssemblyAI API key not found in config');
                    }
                    
                    transcriptionService.setApiKey(assemblyAIConfig.apiKey);
                    console.log('✅ Transcription service initialized successfully');
                } catch (error) {
                    console.error('❌ Failed to load API key:', error);
                    updateStatus('API key error', 'ready');
                    return;
                }
            } catch (error) {
                console.error('❌ Failed to initialize transcription service:', error);
                console.error('❌ Error details:', error.message, error.stack);
                updateListeningIndicator('Initialization failed', false);
                return;
            }

            setupTranscriptionEventListeners();
        }

        async function toggleRecording() {
            console.log('🎤 Toggle recording clicked, current state:', isRecording);
            
            if (!transcriptionService) {
                console.error('❌ Transcription service not initialized');
                alert('Transcription service not available. Please restart the app.');
                return;
            }

            try {
                if (!isRecording) {
                    await startRecording();
                } else {
                    await stopRecording();
                }
            } catch (error) {
                console.error('❌ Error toggling recording:', error);
                const errorMessage = error?.message || error?.toString() || 'Unknown error';
                alert('Error: ' + errorMessage);
            }
        }

        async function startRecording() {
            console.log('🎤 Starting recording...');
            
            if (!transcriptionService) {
                console.error('❌ Transcription service not initialized');
                alert('Transcription service not available. Please restart the app.');
                return;
            }
            
            try {
                await transcriptionService.startTranscription();
                
                isRecording = true;
                updateRecordButton();
                console.log('✅ Recording started successfully');
                
            } catch (error) {
                console.error('❌ Failed to start recording:', error);
                const errorMessage = error?.message || error?.toString() || 'Unknown error';
                throw error;
            }
        }

        async function stopRecording() {
            console.log('🎤 Stopping recording...');
            
            try {
                const session = await transcriptionService.stopTranscription();
                
                isRecording = false;
                updateRecordButton();
                
                console.log('✅ Recording stopped successfully, session:', session);
                
            } catch (error) {
                console.error('❌ Failed to stop recording:', error);
                
                isRecording = false;
                updateRecordButton();
            }
        }

        function updateListeningIndicator(text, isRecording) {
            const indicator = document.getElementById('listeningIndicator');
            indicator.textContent = text;
            
            if (isRecording) {
                indicator.classList.add('recording');
            } else {
                indicator.classList.remove('recording');
            }
        }

        function updateRecordButton() {
            const btn = document.getElementById('recordBtn');
            const icon = document.getElementById('recordIcon');
            
            if (isRecording) {
                btn.classList.remove('idle');
                btn.classList.add('recording');
                icon.textContent = '⏸';
            } else {
                btn.classList.remove('recording');
                btn.classList.add('idle');
                icon.textContent = '▶';
            }
        }

        function clearTranscriptUI() {
            currentTranscript = [];
            speakers.clear();
            const container = document.getElementById('transcriptContainer');
            container.innerHTML = '';
        }

        function getSpeakerColor(speaker) {
            const speakerIndex = Array.from(speakers).indexOf(speaker);
            return speakerColors[speakerIndex % speakerColors.length];
        }

        function updatePartialTranscript(data) {
            const container = document.getElementById('transcriptContainer');
            
            // Remove empty state if present
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            // Only update if text is meaningful
            if (!data.text || data.text.trim().length < 3) return;
            
            let partialElement = container.querySelector('.transcript-message.partial');
            if (!partialElement) {
                partialElement = document.createElement('div');
                partialElement.className = 'transcript-message partial';
                container.appendChild(partialElement);
            }
            
            const speakerNum = Array.from(speakers).indexOf(data.speaker) + 1;
            const speakerClass = `speaker-${Math.min(speakerNum, 3)}`;
            
            partialElement.innerHTML = `
                <div class="message-header">
                    <div class="speaker-avatar ${speakerClass}">${data.speaker.charAt(0)}</div>
                    <div class="speaker-name">${data.speaker}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="message-content partial">${data.text}</div>
            `;
            
            container.scrollTop = container.scrollHeight;
        }

        function addFinalTranscript(data) {
            const container = document.getElementById('transcriptContainer');
            
            // Remove empty state if present
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            // Remove partial element
            const partialElement = container.querySelector('.transcript-message.partial');
            if (partialElement) {
                partialElement.remove();
            }
            
            const finalElement = document.createElement('div');
            finalElement.className = 'transcript-message final';
            
            const speakerNum = Array.from(speakers).indexOf(data.speaker) + 1;
            const speakerClass = `speaker-${Math.min(speakerNum, 3)}`;
            
            finalElement.innerHTML = `
                <div class="message-header">
                    <div class="speaker-avatar ${speakerClass}">${data.speaker.charAt(0)}</div>
                    <div class="speaker-name">${data.speaker}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="message-content">${data.text}</div>
            `;
            
            container.appendChild(finalElement);
            container.scrollTop = container.scrollHeight;
            
            currentTranscript.push(data);
            enableButtons(false);
        }

        function addTurnEndIndicator(data) {
            const container = document.getElementById('transcriptContainer');
            
            // Add a subtle turn separator
            const separator = document.createElement('div');
            separator.className = 'turn-separator';
            separator.innerHTML = `
                <div style="text-align: center; color: rgba(255, 255, 255, 0.3); font-size: 11px; margin: 12px 0; padding: 8px 0; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    ── Turn ended ──
                </div>
            `;
            
            container.appendChild(separator);
            container.scrollTop = container.scrollHeight;
        }

        function saveSession(session) {
            try {
                // Save session data to localStorage or send to main process
                const sessionData = {
                    id: Date.now(),
                    endTime: Date.now(),
                    transcript: currentTranscript,
                    speakers: Array.from(speakers)
                };
                
                // Save to localStorage
                const sessions = JSON.parse(localStorage.getItem('transcription_sessions') || '[]');
                sessions.push(sessionData);
                localStorage.setItem('transcription_sessions', JSON.stringify(sessions));
                
                console.log('✅ Session saved successfully:', sessionData);
            } catch (error) {
                console.error('❌ Failed to save session:', error);
            }
        }

        function toggleMinimize() {
            const panel = document.getElementById('listenPanel');
            const icon = document.getElementById('minimizeIcon');
            
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                panel.classList.add('minimized');
                icon.textContent = '⌃';
            } else {
                panel.classList.remove('minimized');
                icon.textContent = '⌄';
            }
        }

        function closeListen() {
            if (isRecording) {
                if (confirm('Recording is in progress. Stop recording and close?')) {
                    stopRecording().then(() => {
                        if (ipcRenderer) {
                            ipcRenderer.send('close-listen-panel');
                        }
                    });
                }
            } else {
                if (ipcRenderer) {
                    ipcRenderer.send('close-listen-panel');
                }
            }
        }

        // Handle IPC events
        if (ipcRenderer) {
            ipcRenderer.on('force-stop-recording', () => {
                if (isRecording) {
                    stopRecording();
                }
            });
        }
    </script>
</body>
</html>
        }

        function saveSession(session) {
            console.log('💾 Saving session to localStorage:', session);
            
            try {
                const sessions = JSON.parse(localStorage.getItem('transcription_sessions') || '[]');
                
                // Show Multichannel Audio since we're using separate channels
                const audioSourceLabel = 'Multichannel Audio (Separate Mic + System)';
                
                const sessionData = {
                    id: session.id,
                    title: `Meeting ${new Date(session.startTime).toLocaleDateString()} ${new Date(session.startTime).toLocaleTimeString()}`,
                    startTime: session.startTime,
                    endTime: session.endTime,
                    duration: session.duration,
                    transcript: session.transcript || [],
                    speakers: Array.isArray(session.speakers) ? session.speakers : Array.from(session.speakers || []),
                    summary: session.summary || 'No summary available',
                    audioSource: session.audioSource || 'microphone',
                    audioSourceLabel: audioSourceLabel,
                    createdAt: new Date().toISOString()
                };
                
                sessions.unshift(sessionData);
                
                if (sessions.length > 50) {
                    sessions.splice(50);
                }
                
                localStorage.setItem('transcription_sessions', JSON.stringify(sessions));
                
                ipcRenderer.send('sessions-updated');
                
                console.log('✅ Session saved successfully:', sessionData);
                
                updateStatus(`Session saved (${Math.round(session.duration / 1000 / 60)} min)`, 'idle');
                
            } catch (error) {
                console.error('❌ Failed to save session:', error);
                updateStatus('Failed to save session', 'idle');
            }
        }

        function resetUI() {
            document.getElementById('stats').style.display = 'none';
            clearTranscript();
            
            const container = document.getElementById('transcriptContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">🎙️</div>
                    <div class="empty-title">Ready to Listen</div>
                    <div class="empty-subtitle">Press play to start multichannel transcription</div>
                </div>
            `;
        }

        function toggleMinimize() {
            isMinimized = !isMinimized;
            const panel = document.getElementById('listenPanel');
            const icon = document.getElementById('minimizeIcon');
            
            if (isMinimized) {
                panel.classList.add('minimized');
                icon.textContent = '⌃';
            } else {
                panel.classList.remove('minimized');
                icon.textContent = '⌄';
            }
            
            ipcRenderer.send('listen-panel-minimized', isMinimized);
        }

        function closeListen() {
            if (isRecording) {
                if (confirm('Recording is in progress. Stop recording and close?')) {
                    stopRecording().then(() => {
                        ipcRenderer.send('close-listen-panel');
                    });
                }
            } else {
                ipcRenderer.send('close-listen-panel');
            }
        }
    </script>
</body>
</html>