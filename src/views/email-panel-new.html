<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .email-panel {
            width: 480px;
            height: 600px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 24px 48px rgba(0, 0, 0, 0.6),
                0 12px 24px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .panel-header {
            height: 52px;
            background: rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            cursor: move;
            -webkit-app-region: drag;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 18px;
        }

        .header-title {
            font-size: 15px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }

        .header-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .control-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .back-btn {
            background: rgba(255, 165, 0, 0.2);
            color: rgba(255, 165, 0, 0.9);
            display: none;
        }

        .back-btn:hover {
            background: rgba(255, 165, 0, 0.3);
        }

        /* Content Area */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            min-height: 0;
        }

        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Views */
        .view {
            display: none;
            height: 100%;
        }

        .view.active {
            display: flex;
            flex-direction: column;
        }

        /* Client Selection */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            height: 100%;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
        }

        .empty-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: rgba(0, 122, 255, 0.8);
            color: white;
        }

        .btn-primary:hover {
            background: rgba(0, 122, 255, 0.9);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Client List */
        .client-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .client-item {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .client-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .client-item.selected {
            background: rgba(255, 165, 0, 0.15);
            border-color: rgba(255, 165, 0, 0.4);
        }

        .client-name {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }

        .client-company {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
        }

        .client-email {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        .client-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .check-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 18px;
            color: rgba(255, 165, 0, 0.9);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .client-item.selected .check-icon {
            opacity: 1;
        }

        /* Brief Selection */
        .client-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .client-info-name {
            font-size: 18px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }

        .client-info-company {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .source-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-tab:hover {
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.9);
        }

        .filter-tab.active {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.4);
            color: rgba(255, 165, 0, 0.9);
        }

        /* Brief List */
        .brief-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .brief-item {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .brief-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .brief-item.selected {
            background: rgba(255, 165, 0, 0.15);
            border-color: rgba(255, 165, 0, 0.4);
        }

        .brief-title {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .brief-objective {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .brief-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Email Editor */
        .email-form {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.flex-grow {
            flex: 1;
            min-height: 0;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: rgba(0, 122, 255, 0.6);
            background: rgba(255, 255, 255, 0.12);
        }

        .form-textarea {
            resize: none;
            height: 100%;
            min-height: 200px;
            line-height: 1.5;
        }

        .editor-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        /* Action Bar */
        .action-bar {
            height: 72px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 24px;
            gap: 12px;
            flex-shrink: 0;
        }

        .btn-action {
            background: rgba(255, 165, 0, 0.8);
            color: white;
            min-width: 120px;
            justify-content: center;
        }

        .btn-action:hover {
            background: rgba(255, 165, 0, 0.9);
        }

        .btn-action:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .btn-action:disabled:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-height: 700px) {
            .email-panel {
                height: 90vh;
                max-height: 600px;
            }
            
            .panel-content {
                padding: 20px;
            }
            
            .client-list,
            .brief-list {
                max-height: 250px;
            }
        }

        /* Loading state */
        .btn-action.loading {
            pointer-events: none;
        }

        .btn-action.loading .btn-text {
            opacity: 0.7;
        }

        /* Fade animations */
        .view {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .view.active {
            opacity: 1;
        }

        /* Focus styles */
        .client-item:focus,
        .brief-item:focus {
            outline: 2px solid rgba(0, 122, 255, 0.6);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="email-panel">
        <!-- Header -->
        <div class="panel-header">
            <div class="header-left">
                <button class="control-btn back-btn" id="backBtn" onclick="handleBack()">←</button>
                <div class="header-icon">✉️</div>
                <div class="header-title" id="headerTitle">Select Client</div>
            </div>
            <div class="header-controls">
                <button class="control-btn" onclick="minimizePanel()">−</button>
                <button class="control-btn" onclick="closePanel()">×</button>
            </div>
        </div>

        <!-- Content -->
        <div class="panel-content">
            <!-- Client Selection View -->
            <div class="view active" id="clientView">
                <div id="clientContent">
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div class="empty-title">No clients found</div>
                        <div class="empty-subtitle">Add clients in Settings to create follow-up emails</div>
                        <button class="btn btn-primary" onclick="openSettings()">
                            Go to Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Brief Selection View -->
            <div class="view" id="briefView">
                <div class="client-info">
                    <div class="client-info-name" id="selectedClientName"></div>
                    <div class="client-info-company" id="selectedClientCompany"></div>
                </div>

                <div class="source-filters">
                    <button class="filter-tab active" data-source="all">
                        <span>📋</span> All Sources
                    </button>
                    <button class="filter-tab" data-source="calendar">
                        <span>📅</span> Calendar
                    </button>
                    <button class="filter-tab" data-source="recordings">
                        <span>🎵</span> Recordings
                    </button>
                    <button class="filter-tab" data-source="briefs">
                        <span>📄</span> Briefs
                    </button>
                </div>

                <div id="briefContent">
                    <div class="empty-state">
                        <div class="empty-icon">📄</div>
                        <div class="empty-title">No meeting content found</div>
                        <div class="empty-subtitle">Create meeting briefs, record meetings, or connect your calendar to generate follow-up emails</div>
                    </div>
                </div>
            </div>

            <!-- Email Editor View -->
            <div class="view" id="editorView">
                <div class="email-form">
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="emailSubject" placeholder="Email Subject">
                    </div>
                    <div class="form-group flex-grow">
                        <label class="form-label">Email Body</label>
                        <textarea class="form-input form-textarea" id="emailBody" placeholder="Email content will appear here..."></textarea>
                    </div>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="goBack()">← Back</button>
                        <button class="btn btn-secondary" id="regenerateBtn" onclick="regenerateEmail()" disabled>Regenerate</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <button class="btn btn-action" id="actionBtn" onclick="handleAction()" disabled>
                <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
                <span class="btn-text" id="actionBtnText">Next</span>
            </button>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const AIConnectionManager = require('../services/AIConnectionManager');

        // Application state
        let appState = {
            currentView: 'client',
            clients: [],
            selectedClient: null,
            selectedBrief: null,
            isLoading: false,
            aiConnection: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadClients();
        });

        async function initializeApp() {
            try {
                const { getInstance } = require('../services/AIConnectionManager');
                appState.aiConnection = getInstance();
                
                appState.aiConnection.on('responseComplete', () => {
                    handleEmailGenerated();
                });
            } catch (error) {
                console.error('Failed to initialize AI connection:', error);
            }
        }

        function setupEventListeners() {
            // Source filter tabs
            document.addEventListener('click', function(e) {
                if (e.target.closest('.filter-tab')) {
                    const sourceType = e.target.closest('.filter-tab').dataset.source;
                    selectSourceFilter(sourceType);
                }
            });

            // Client updates from settings
            ipcRenderer.on('clients-updated', () => {
                setTimeout(() => loadClients(), 100);
            });

            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePanel();
                } else if (e.key === 'Enter' && !e.shiftKey) {
                    const actionBtn = document.getElementById('actionBtn');
                    if (!actionBtn.disabled) {
                        handleAction();
                    }
                }
            });
        }

        async function loadClients() {
            try {
                appState.clients = await ipcRenderer.invoke('get-clients');
                console.log('Loaded clients:', appState.clients);
                renderClientView();
            } catch (error) {
                console.error('Failed to load clients:', error);
                appState.clients = [];
                renderClientView();
            }
        }

        function renderClientView() {
            const content = document.getElementById('clientContent');
            
            if (appState.clients.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div class="empty-title">No clients found</div>
                        <div class="empty-subtitle">Add clients in Settings to create follow-up emails</div>
                        <button class="btn btn-primary" onclick="openSettings()">
                            Go to Settings
                        </button>
                    </div>
                `;
                updateActionButton(false, 'Next');
                return;
            }

            const clientsHtml = appState.clients.map(client => `
                <div class="client-item" onclick="selectClient('${client.id}')" tabindex="0">
                    <div class="client-name">${escapeHtml(client.name)}</div>
                    <div class="client-company">${escapeHtml(client.company)}</div>
                    ${client.email ? `<div class="client-email">${escapeHtml(client.email)}</div>` : ''}
                    <div class="client-meta">
                        ${client.briefHistory ? client.briefHistory.length : 0} meeting${client.briefHistory && client.briefHistory.length === 1 ? '' : 's'}
                        ${client.industry ? ` • ${escapeHtml(client.industry)}` : ''}
                    </div>
                    <div class="check-icon">✓</div>
                </div>
            `).join('');

            content.innerHTML = `<div class="client-list">${clientsHtml}</div>`;
        }

        function selectClient(clientId) {
            appState.selectedClient = appState.clients.find(c => c.id === clientId);
            
            // Update UI
            document.querySelectorAll('.client-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.client-item').classList.add('selected');
            
            updateActionButton(true, 'Next');
        }

        function renderBriefView() {
            document.getElementById('selectedClientName').textContent = appState.selectedClient.name;
            document.getElementById('selectedClientCompany').textContent = appState.selectedClient.company;

            const content = document.getElementById('briefContent');
            
            if (!appState.selectedClient.briefHistory || appState.selectedClient.briefHistory.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📄</div>
                        <div class="empty-title">No meeting briefs found</div>
                        <div class="empty-subtitle">Create meeting briefs first to generate follow-up emails</div>
                    </div>
                `;
                updateActionButton(false, 'Generate Email');
                return;
            }

            const sortedBriefs = appState.selectedClient.briefHistory.sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            const briefsHtml = sortedBriefs.map(brief => `
                <div class="brief-item" onclick="selectBrief('${brief.id}')" tabindex="0">
                    <div class="brief-title">${escapeHtml(brief.title)}</div>
                    <div class="brief-objective">${escapeHtml(brief.objective)}</div>
                    <div class="brief-date">${formatDate(brief.createdAt)}</div>
                    <div class="check-icon">✓</div>
                </div>
            `).join('');

            content.innerHTML = `<div class="brief-list">${briefsHtml}</div>`;
        }

        function selectBrief(briefId) {
            appState.selectedBrief = appState.selectedClient.briefHistory.find(b => b.id === briefId);
            
            // Update UI
            document.querySelectorAll('.brief-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.brief-item').classList.add('selected');
            
            updateActionButton(true, 'Generate Email');
        }

        function selectSourceFilter(sourceType) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-source="${sourceType}"]`).classList.add('active');
            
            // Re-render briefs (placeholder for future filtering logic)
            renderBriefView();
        }

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(viewName + 'View').classList.add('active');
            appState.currentView = viewName;
            
            // Update header and back button
            const backBtn = document.getElementById('backBtn');
            const headerTitle = document.getElementById('headerTitle');
            
            switch (viewName) {
                case 'client':
                    headerTitle.textContent = 'Select Client';
                    backBtn.style.display = 'none';
                    updateActionButton(appState.selectedClient !== null, 'Next');
                    break;
                case 'brief':
                    headerTitle.textContent = 'Select Meeting Source';
                    backBtn.style.display = 'flex';
                    renderBriefView();
                    break;
                case 'editor':
                    headerTitle.textContent = 'Follow-up Email';
                    backBtn.style.display = 'flex';
                    updateActionButton(true, 'Send Email');
                    document.getElementById('regenerateBtn').disabled = false;
                    break;
            }
        }

        function handleAction() {
            if (appState.isLoading) return;
            
            switch (appState.currentView) {
                case 'client':
                    if (appState.selectedClient) {
                        showView('brief');
                    }
                    break;
                case 'brief':
                    if (appState.selectedBrief) {
                        generateEmail();
                    }
                    break;
                case 'editor':
                    sendEmail();
                    break;
            }
        }

        function handleBack() {
            switch (appState.currentView) {
                case 'brief':
                    appState.selectedBrief = null;
                    showView('client');
                    break;
                case 'editor':
                    showView('brief');
                    break;
            }
        }

        function goBack() {
            handleBack();
        }

        async function generateEmail() {
            if (!appState.selectedClient || !appState.selectedBrief || appState.isLoading) return;

            setLoading(true, 'Generating...');

            const followUpDate = new Date();
            followUpDate.setDate(followUpDate.getDate() + 7);

            const prompt = `Generate a professional follow-up email based on this meeting information:

Client: ${appState.selectedClient.name} from ${appState.selectedClient.company}
Meeting Brief: ${appState.selectedBrief.title}
Meeting Objective: ${appState.selectedBrief.objective}
Meeting Content: ${appState.selectedBrief.content}
Meeting Date: ${formatDate(appState.selectedBrief.createdAt)}
Follow-up Date: ${formatDate(followUpDate)}

Please generate a professional follow-up email that:
1. Thanks them for their time in the meeting
2. Briefly recaps the key points from the meeting content
3. References the meeting objective and how it was addressed
4. Suggests next steps based on the discussion
5. Maintains a warm but professional tone
6. Sounds natural and personalized to this specific client and meeting

Format your response as:
SUBJECT: [subject line]

BODY:
[email body]`;

            try {
                appState.aiConnection.clearConversation();
                
                const timeout = setTimeout(() => {
                    if (appState.isLoading) {
                        handleEmailGenerated();
                    }
                }, 30000);

                appState.aiConnection.once('responseComplete', () => {
                    clearTimeout(timeout);
                });

                await appState.aiConnection.sendMessage(prompt);
            } catch (error) {
                console.error('Error generating email:', error);
                setLoading(false);
                alert('Failed to generate email. Please try again.');
            }
        }

        function handleEmailGenerated() {
            if (!appState.isLoading) return;

            let response = '';
            if (appState.aiConnection.lastMessages && appState.aiConnection.lastMessages.length > 0) {
                const lastMessage = appState.aiConnection.lastMessages[appState.aiConnection.lastMessages.length - 1];
                if (!lastMessage.isUser) {
                    response = lastMessage.message;
                }
            }

            if (!response && appState.aiConnection.messageStream) {
                response = appState.aiConnection.messageStream;
            }

            if (response) {
                parseAndDisplayEmail(response);
                setLoading(false);
                showView('editor');
            } else {
                console.error('No response received from AI');
                setLoading(false);
                alert('Failed to generate email. Please try again.');
            }
        }

        function parseAndDisplayEmail(response) {
            let subject = '';
            let body = '';
            
            const subjectMatch = response.match(/SUBJECT:\s*(.+)/);
            const bodyMatch = response.match(/BODY:\s*([\s\S]+)/);
            
            if (subjectMatch) {
                subject = subjectMatch[1].trim();
            }
            
            if (bodyMatch) {
                body = bodyMatch[1].trim();
            }
            
            // Fallback parsing
            if (!subject || !body) {
                const lines = response.split('\n');
                let isBodySection = false;
                
                for (const line of lines) {
                    if (line.startsWith('SUBJECT:')) {
                        subject = line.substring(8).trim();
                    } else if (line.startsWith('BODY:')) {
                        isBodySection = true;
                    } else if (isBodySection) {
                        body += line + '\n';
                    }
                }
                
                if (!subject) {
                    subject = 'Follow-up from our meeting';
                }
                if (!body) {
                    body = response;
                }
            }

            document.getElementById('emailSubject').value = subject;
            document.getElementById('emailBody').value = body.trim();
        }

        function regenerateEmail() {
            if (!appState.isLoading) {
                generateEmail();
            }
        }

        function sendEmail() {
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();

            if (!subject || !body) {
                alert('Please ensure all fields are filled.');
                return;
            }

            if (!appState.selectedClient.email) {
                alert('Selected client does not have an email address.');
                return;
            }

            const mailtoUrl = `mailto:${encodeURIComponent(appState.selectedClient.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            require('electron').shell.openExternal(mailtoUrl);
            closePanel();
        }

        function updateActionButton(enabled, text) {
            const btn = document.getElementById('actionBtn');
            const btnText = document.getElementById('actionBtnText');
            
            btn.disabled = !enabled;
            btnText.textContent = text;
        }

        function setLoading(loading, text = null) {
            appState.isLoading = loading;
            const btn = document.getElementById('actionBtn');
            const btnText = document.getElementById('actionBtnText');
            const spinner = document.getElementById('loadingSpinner');
            
            if (loading) {
                btn.classList.add('loading');
                btn.disabled = true;
                spinner.style.display = 'block';
                if (text) btnText.textContent = text;
            } else {
                btn.classList.remove('loading');
                spinner.style.display = 'none';
                updateActionButton(true, getActionButtonText());
            }
        }

        function getActionButtonText() {
            switch (appState.currentView) {
                case 'client': return 'Next';
                case 'brief': return 'Generate Email';
                case 'editor': return 'Send Email';
                default: return 'Next';
            }
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Window controls
        function closePanel() {
            ipcRenderer.send('close-email-panel');
        }

        function minimizePanel() {
            ipcRenderer.send('minimize-email-panel');
        }

        function openSettings() {
            ipcRenderer.send('show-settings');
        }
    </script>
</body>
</html>
